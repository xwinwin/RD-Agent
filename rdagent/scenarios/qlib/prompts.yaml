hypothesis_and_feedback: |-
  =========================================================
  {% for experiment, feedback in trace.hist %}
  # 试验 {{ loop.index }}: 
  ## 假设
  {{ experiment.hypothesis }}
  ## 具体任务: 
  {% for task in experiment.sub_tasks %}
  {% if task is not none and task.get_task_brief_information is defined %}
  {{ task.get_task_brief_information() }}
  {% endif %}
  {% endfor %}
  ## 回测分析和反馈:
  {% if experiment.result is not none %}
  回测结果: {{ experiment.result.loc[["IC", "1day.excess_return_without_cost.annualized_return", "1day.excess_return_without_cost.max_drawdown"]] }}
  {% endif %}
  观察: {{ feedback.observations }}
  假设评估: {{ feedback.hypothesis_evaluation }}
  决策（假设是否成功）: {{ feedback.decision }}
  =========================================================
  {% endfor %}

last_hypothesis_and_feedback: |-
  ## 假设
  {{ experiment.hypothesis }}
  ## 具体任务: 
  {% for task in experiment.sub_tasks %}
  {% if task is not none and task.get_task_brief_information is defined %}
  {{ task.get_task_brief_information() }}
  {% endif %}
  {% endfor %}
  ## 回测分析和反馈:
  {% if experiment.result is not none %}
  回测结果: {{ experiment.result.loc[["IC", "1day.excess_return_without_cost.annualized_return", "1day.excess_return_without_cost.max_drawdown"]] }}
  {% endif %}
  训练日志: 
  在这里，你需要关注分析训练是否存在任何问题。如果发现问题，你必须在下次迭代中纠正它们，并在假设中清楚地描述如何进行更改。
  {{ experiment.stdout }} 
  观察: {{ feedback.observations }}
  评估: {{ feedback.hypothesis_evaluation }}
  决策（本次实验是否是最优的）: {{ feedback.decision }}
  新假设（在反馈阶段给出，仅供参考，可在下一轮接受或拒绝）: {{ feedback.new_hypothesis }}
  推理（新假设的理由）: {{ feedback.reason }}

sota_hypothesis_and_feedback: |-
  ## 假设
  {{ experiment.hypothesis }}
  ## 具体任务: 
  {% for task in experiment.sub_tasks %}
  {% if task is not none and task.get_task_brief_information is defined %}
  {{ task.get_task_brief_information() }}
  {% endif %}
  {% endfor %}
  ## 回测分析和反馈:
  {% if experiment.result is not none %}
  回测结果: {{ experiment.result.loc[["IC", "1day.excess_return_without_cost.annualized_return", "1day.excess_return_without_cost.max_drawdown"]] }}
  {% endif %}
  训练日志: {{ experiment.stdout }}
  观察: {{ feedback.observations }}
  评估: {{ feedback.hypothesis_evaluation }}
  决策（本次实验是否是最优的）: {{ feedback.decision }}

hypothesis_output_format: |-
  输出应遵循JSON格式。模式如下：
  {
  "hypothesis": "根据先前实验轨迹分析得出的精确、可测试且创新的陈述。避免过于笼统的想法，确保精确。假设应清楚地指定具体方法和预期改进，用两三句话表达。",
  "reason": "清晰地解释为什么提出这个假设，以证据为基础（例如，轨迹历史、领域原则）。理由应简短，不超过两句话。",
  }

factor_hypothesis_output_format: |-
  输出应遵循JSON格式。模式如下：
  {
  "hypothesis": "基于提供的信息生成的新假设。限制在两三句话内。",
  "reason": "生成这个假设的原因。它应该是全面且逻辑清晰的。它应该涵盖下面的其他键并扩展它们。限制在两三句话内。",
  }

hypothesis_output_format_with_action: |-
  输出应遵循JSON格式。模式如下：
  {
  "action": "如果`hypothesis_specification`提供了你需要采取的行动，请遵循\"hypothesis_specification\"来选择行动。否则，根据先前的实验结果，建议你认为当前最合适的行动。它应该是[`factor`（因子）, `model`（模型）]之一。",
  "hypothesis": "基于提供的信息生成的新假设，应该是字符串。",
  "reason": "生成这个假设的原因。它应该是全面且逻辑清晰的。它应该涵盖下面的其他键并扩展它们。限制在两三句话内。",
  }

model_hypothesis_specification: |-
  1. 首先，观察并分析`hypothesis_and_feedback`中的整体实验进展。分析先前模型设计不足的原因——是由于参数设置、架构缺陷还是缺乏创新（只要能证明有效性，完全提出新概念是非常鼓励的）。
  2. 其次，`last_hypothesis_and_feedback`和`sota_hypothesis_and_feedback`是你应该密切关注的关键参考。你可以选择基于其中任何一个进行优化，或生成新想法来形成假设和实验。
  3. 如果一开始没有可用的先前实验或结果，你可以从实现一个简单的小型架构开始。
  4. 如果一系列尝试未能达到最优（SOTA），考虑探索全新的方向；在这种情况下，可以回到简单架构。
  5. 只专注于PyTorch模型的架构。每个假设应具体解决架构决策，如层配置、激活函数、正则化方法和整体模型结构。不要进行任何特定于特征的处理。相反，你可以对输入时间序列数据提出创新性转换，以增强模型训练效果。
  6. 避免包含与架构无关的方面，如输入特征或优化策略。
  7. 有时，当训练性能不佳时，调整超参数也可以是有效的改进策略。
  8. 对基线模型使用标准库，但也要探索自定义架构设计以研究新结构。在对传统模型进行足够试验后，目标是实现与顶级AI会议（NeurIPS, ICLR, ICML, SIGKDD等）相当的时间序列建模创新。

factor_hypothesis_specification: |-
  1. **每代1-5个因子：**
    - 确保每代产生1-5个因子。
    - 平衡简单性和复杂性以构建稳健的因子库。
    - 充分利用提供给你的金融数据，而不是只关注特定领域。
  2. **首先简单有效的因子：**
    - 从简单、易于实现且可能有效的因子开始。
    - 简要解释为什么这些因子预期有效。
    - 最初避免复杂或组合因子。
  3. **逐渐增加复杂性：**
    - 随着更多实验结果的收集，引入更复杂的因子（例如基于机器学习的因子、使用多维因子原始数据的因子等）。
    - 只有在更简单的因子经过测试和验证后才组合因子。
  4. **新方向和优化：**
    - 如果多次连续迭代未能产生超越SOTA的因子，考虑转向新方向，可以再次从简单因子开始。
    - 如果优化特定类型的因子，从简单到复杂进行。
  5. 注意
    - 强调超越SOTA的因子会被包含在库中以避免重复实现。
    - 无论你计划生成多少个因子，只回复一组假设和理由。假设可以同时包括多个因子的提出。

factor_experiment_output_format: |-
  输出应遵循JSON格式。模式如下：
  {
      "因子名称1": {
          "描述": "因子1的描述，从其类型开始，例如[动量因子（Momentum Factor）]",
          "公式": "因子1的latex公式",
          "变量": {
              "变量或函数名称1": "变量或函数1的描述",
              "变量或函数名称2": "变量或函数2的描述"
          }
      },
      "因子名称2": {
          "描述": "因子2的描述，从其类型开始，例如[基于机器学习的因子（Machine Learning based Factor）]",
          "公式": "因子2的latex公式",
          "变量": {
              "变量或函数名称1": "变量或函数1的描述",
              "变量或函数名称2": "变量或函数2的描述"
          }
      }
      # 不要在此处添加省略号(...)或任何可能导致JSON解析错误的填充文本！
  }

model_experiment_output_format: |-
  迄今为止请只设计一个模型来测试假设！
  输出应遵循JSON格式。模式如下（training_hyperparameters中的值是参考设置，你可以根据先前的训练日志进行更改）：
  {
    "model_name (模型的名称)": {
        "描述": "模型的详细描述",
        "公式": "代表模型公式的LaTeX公式",
        "架构": "模型架构的详细描述，例如神经网络层或树结构",
        "变量": {
            "\\hat{y}_u": "节点u的预测输出",
            "variable_name_2": "变量2的描述",
            "variable_name_3": "变量3的描述"
        },
        "超参数": {
            "hyperparameter_name_1": "超参数1的值",
            "hyperparameter_name_2": "超参数2的值",
            "hyperparameter_name_3": "超参数3的值"
        },
        "training_hyperparameters" {  # 所有值仅供参考；你可以自己设置
            "n_epochs": "100",
            "lr": "1e-3",
            "early_stop": 10,
            "batch_size": 256,
            "weight_decay": 1e-4,
        }
        "model_type": "表格型或时间序列型"  # 应该是"表格型（Tabular）"或"时间序列型（TimeSeries）"之一
    },
  }

factor_feedback_generation:
  system: |-
    你是在数据驱动研发中的专业金融结果分析助手。
    任务在以下场景中描述：

    {{ scenario }}
    
    你将收到假设、多个任务及其因子、它们的结果和SOTA结果。
    你的反馈应该指定当前结果支持还是反驳假设，与先前SOTA（State of the Art，最先进水平）结果比较，并建议改进或新方向。
    
    请理解以下操作逻辑，然后使你的反馈适合场景：
      1. 逻辑解释：
        a) 所有在先前尝试中超越SOTA的因子都将被包含在SOTA因子库中。
        b) 新实验将生成新因子，这些因子将与SOTA库中的因子组合。
        c) 这些组合因子将进行回测，并与当前SOTA比较以实现持续迭代。
      2. 开发方向：
        a) 新方向：为探索和发展提出新的因子方向。
        b) 现有方向优化：
          - 建议对该因子的进一步改进（这可以包括对因子的进一步优化，或提出与该因子更好组合的方向）。
          - 避免重新实现先前因子，因为超越SOTA的因子已包含在因子库中，每次运行都会使用。
      3. 最终目标：持续积累超越每次迭代的因子以保持最佳SOTA。
    
    在判断结果时：
      1. 任何小的改进都应考虑纳入SOTA（将`Replace Best Result`设为yes）。
      2. 如果新因子年化收益率有改善，建议它取代当前最佳结果。
      3. 只要年化收益率有改善，其他指标的微小变化是可以接受的。

    考虑当结果与SOTA存在显著差距时改变方向：
      - 如果新结果与SOTA显著不同，考虑探索新方向（编写新类型因子）。
      - 避免重新实现先前因子，因为超越SOTA的因子已包含在因子库中，每次运行都会使用。

    请为未来探索提供详细且建设性的反馈。
    以JSON格式回复。结果分析的示例JSON结构：
    {
      "Observations": "你在这里的总体观察",
      "Feedback for Hypothesis": "与假设相关的观察",
      "New Hypothesis": "你的新假设",
      "Reasoning": "新假设的推理",
      "Replace Best Result": "yes or no"
    }
  user: |-
    目标假设: 
    {{ hypothesis_text }}
    任务和因子:
    {% for task in task_details %}
      - {{ task.factor_name }}: {{ task.factor_description }}
        - 因子公式: {{ task.factor_formulation }}
        - 变量: {{ task.variables }}
        - 因子实现: {{ task.factor_implementation }}
        {% if task.factor_implementation == "False" %}
        **注意：此因子在当前实验中没有实现。只能验证已实现因子的假设。**
        {% endif %}
    {% endfor %}
    组合结果: 
    {{ combined_result }}
    
    在支持或反驳假设的能力背景下分析组合结果：
    1. 支持或反驳假设。
    2. 与SOTA实验相比显示改进或恶化。
    
    注意：只有'因子实现'为True的因子才在本次实验中实现和测试。如果'因子实现'为False，则无法在本次运行中验证该因子的假设。

model_feedback_generation:
  system: |-
    你是一家顶级对冲基金的专业定量分析助手。

    任务在以下场景中描述：
    {{ scenario }}

    你将收到定量模型假设、其具体任务描述及其市场回测结果。
    你的反馈应该指定当前结果支持还是反驳假设，与先前SOTA结果比较，检查模型的训练日志以分析超参数设置是否存在问题，并建议改进或新方向。

    请提供详细且建设性的反馈。
    结果分析的示例JSON结构：
    {
      "Observations": "首先分析模型的训练日志以确定其参数设置是否存在问题。然后用精确的分数和任何显著模式清楚地总结当前结果和SOTA结果。将你的总结限制在不超过三句简洁的、以数据为中心的句子中。",
      "Feedback for Hypothesis": "根据具体数据点或性能趋势明确确认或反驳假设。限制在两句话内。",
      "New Hypothesis": "提出修订后的假设，考虑观察到的模式和当前假设中的局限性。限制在不超过两句话。",
      "Reasoning": "用具体趋势或性能变化解释新假设的基本原理。简洁但技术完整。限制在两句话内。",
      "Decision": <true or false>,
    }

    
  user: |-
    {% if sota_hypothesis %} 
    # SOTA轮次信息：
    假设: {{ sota_hypothesis.hypothesis }}
    具体任务: {{ sota_task }}
    代码实现: {{ sota_code }}
    结果: {{ sota_result }}
    {% else %}
    # 这是第一轮。没有可用的先前信息。只要性能不要太差（例如ICIR大于0），就视为成功。不要把门槛设得太高。  
    {% endif %} 
    
    # 当前轮次信息：
    假设: {{ hypothesis.hypothesis }}
    为什么提出这个假设: {{ hypothesis.reason }}
    具体任务: {{ exp.sub_tasks[0].get_task_information() }}
    代码实现: {{ exp.sub_workspace_list[0].file_dict.get("model.py") }}
    训练日志: {{ exp.stdout }}
    结果: {{ exp_result }}

    # 在判断结果时：
    1. **替换建议：**
      - 如果新模型的年化收益率有改善，建议它取代当前SOTA结果。
      - 只要年化收益率有改善，其他指标的微小变化是可以接受的。
    2. 当结果显著差于SOTA时考虑改变方向：
      - 如果新结果显著差于SOTA，考虑探索新方向，如改变模型架构。

action_gen:
  system: |-
    量化投资是一种数据驱动的资产管理方法，依赖数学模型、统计技术和计算方法来分析金融市场并做出投资决策。这种方法的两个基本组成部分是因子（factors）和模型（models）。
   
    你是一家顶级华尔街对冲基金中最权威的研究员之一。我需要你的专业知识来开发新的因子和模型，以提高我们的投资收益。根据给定的上下文，我会请求你协助设计并实现因子或模型。

    你将收到一系列实验，包括它们的因子和模型及其结果。
    你的任务是分析先前的实验，决定下一次实验应该专注于因子还是模型。

    你返回的示例JSON结构：
    {
      "action": "factor" or "model",  # 你必须选择其中一个
    }

  user: |-
    {% if hypothesis_and_feedback|length == 0 %}
    这是假设生成的第一轮。用户还没有关于这个场景的假设。
    {% else %}
    先前的假设和相应的反馈如下：
    {{ hypothesis_and_feedback }}
    {% endif %}

    
    {% if last_hypothesis_and_feedback != "" %}
    这是上一次试验的假设和相应的反馈。主要反馈包括一个新假设，仅供参考。你应该评估整个推理链，决定是采用它，提出更合适的假设，还是转移并优化到另一个场景（例如，因子/模型），因为一般来说鼓励转移：
    {{ last_hypothesis_and_feedback }}
    {% endif %}
